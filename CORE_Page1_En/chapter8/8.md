# **8. Bumblebee内核低功耗机制介绍**<div id="8"></div>

Bumblebee内核可以支持休眠模式实现较低的静态功耗。



## **8.1. 进入休眠状态**<div id="8-1"></div>

Bumblebee内核可以通过WFI指令进入休眠状态。当处理器执行到WFI指令之后，将会：

- 立即停止执行当前的指令流；
- 等待处理器内核完成任何尚未完成的滞外操作（Outstanding Transactions），譬如取指令和数据读写操作，以保证发到总线上的操作都完成；
  - 注意：如果在等待总线上的操作完成的过程中发生了存储器访问错误异常，则会进入到异常处理模式，而不会休眠。
- 当所有的滞外操作（Outstanding Transactions）都完成后，处理器会安全地进入一种空闲状态，这种空闲状态可以被称之为“休眠”状态。
- 当进入休眠模式后：
  - Bumblebee内核内部的各个主要单元的时钟将会被门控关闭以节省静态功耗；
  - Bumblebee内核的输出信号core_wfi_mode会拉高，指示此处理器核处于执行WFI指令之后的休眠状态；
  - Bumblebee内核的输出信号core_sleep_value会输出CSR寄存器sleepvalue的值（注意：该信号只有在core_wfi_mode信号为高电平时生效；core_wfi_mode信号为低电平时core_sleep_value的值一定是0）。软件可以通过事先配置CSR寄存器sleepvalue来指示不同的休眠模式（0或者1）。注意：
    - 对于不同的休眠模式而言，Bumblebee内核的行为完全一样。此休眠模式只是仅供SoC系统层面的PMU（Power Management Unit）进行相应不同的控制。



## **8.2. 退出休眠状态**<div id="8-2"></div>

Bumblebee内核处理器退出休眠模式的要点如下：

- Bumblebee内核的输出信号core_wfi_mode会相应拉低。
- Bumblebee内核处理器可以通过以下四种方式被唤醒：
  - NMI
  - 中断
  - Event
  - Debug请求

下文将予以详细介绍 。



### **8.2.1. NMI唤醒**<div id="8-2-1"></div>

NMI总能够唤醒处理器内核。当处理器内核检测到输入信号nmi的上升沿，处理器内核被唤醒，进入到NMI服务程序开始执行。



### **8.2.2. 中断唤醒**<div id="8-2-2"></div>

中断也可以唤醒处理器内核：

- 如果CSR寄存器wfe.WFE域被配置为0，则：
  - 如果mstatus.MIE域被配置为1（表示全局中断被打开），则：
    - 当ECLIC（通过将外部请求的中断进行仲裁）向处理器内核发送了中断，处理器内核被唤醒，进入到中断服务程序开始执行。
  - 如果mstatus.MIE域被配置为0（表示全局中断被关闭），则：
    - 当ECLIC（通过将外部请求的中断进行仲裁）向处理器内核发送了中断，处理器内核被唤醒，继续顺序执行之前停止的指令流（而不是进入到中断服务程序）。
- 如果CSR寄存器wfe.WFE域被配置为1，则等待Event唤醒，请参见下节描述。



### **8.2.3. Event唤醒**<div id="8-2-3"></div>

当满足如下条件时，Event可以唤醒处理器内核：

- 如果CSR寄存器wfe.WFE域被配置为1，则：
  - 当处理器内核检测到输入信号rx_evt（称之为Event信号）为高电平时，处理器内核被唤醒，继续执行之前停止的指令流（而不是进入到中断服务程序）。



### **8.2.4. Debug唤醒**<div id="8-2-4"></div>

Debug请求总能够唤醒处理器内核，如果调试器（Debugger）接入，也会将处理器内核唤醒而进入调试模式。



## **8.3. Wait for Interrupt机制**<div id="8-3"></div>

Wait for Interrupt机制，是指将处理器内核进入休眠模式，然后等待中断唤醒处理器内核，醒来后进入相应中断的处理函数中去。

如第8.1节和第8.2节所述，Wait for Interrupt机制可以直接通过WFI指令（配合mstatus.MIE域被配置为1）完成。



## **8.4. Wait for Event机制**<div id="8-4"></div>

Wait for Event机制，是指将处理器内核进入休眠模式，然后等待Event唤醒处理器内核，醒来后继续先前停止的程序（而不是进入中断的处理函数中去）。

如第8.1节和第8.2节所述，Wait for Event机制可以直接通过WFI指令，配合如下指令序列完成：

```
第1步：配置wfe.WFE域为1
第2步：调用WFI指令。调用此指令后处理器会进入休眠模式，当Event或者NMI将其唤醒后将会继续向下执行。
第3步：恢复wfe.WFE域为0
```



